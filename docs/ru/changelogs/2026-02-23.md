---
title: "Тестирование стало богаче, CallbackData — надёжнее, запускается TypeScript API Reference"
head:
    - - meta
      - name: "description"
        content: "Журнал изменений GramIO 18–22 февраля: @gramio/test v0.3.0 добавляет editMessage/forwardMessage/pinMessage/sendMediaGroup/clickByText, @gramio/callback-data v0.1.0 получает safeUnpack(), @gramio/types v9.4.2 переходит на нативный парсер схемы, запускается TypeScript API Reference."
    - - meta
      - name: "keywords"
        content: "gramio, журнал изменений, test, тестирование, callback-data, safeUnpack, schema-parser, api-reference, typescript, фильтры, editMessage, forwardMessage, pinMessage"
---

# Тестирование стало богаче, CallbackData — надёжнее, TypeScript API Reference запущен

**18–22 февраля 2026**

Насыщенная неделя — расширяем то, что уже работает хорошо. `@gramio/test` получает 9 новых методов: редактирование сообщений, пересылка, медиагруппы, закрепление, клик по кнопке по тексту и не только. `@gramio/callback-data` обзаводится `safeUnpack()`, который никогда не падает, плюс безопасное добавление optional-полей. `@gramio/types` v9.4.2 переезжает на нативный TypeScript-парсер схемы. И наконец-то запускается полный TypeScript API Reference по адресу `/api/`.

## [@gramio/test v0.3.0 — больше акторов, больше действий](https://github.com/gramiojs/test/compare/v0.1.0...v0.3.0)

### [9 новых методов: правка, пересылка, закрепление, медиагруппа и clickByText](https://github.com/gramiojs/test/commit/236e7a3651b1e34552a7a2a0eb8d0e9f163cc1a1)

Библиотека для тестирования серьёзно выросла. Вот что появилось:

**`user.editMessage(msg, text)`** — отправляет событие `edited_message`. Тестируйте обработчики редактирования без лишнего кода:

```ts
const msg = await user.sendMessage("Привет");
await user.editMessage(msg, "Привет, мир!");
expect(env.apiCalls[0].method).toBe("editMessageText");
```

**`user.forwardMessage(msg, toChat?)`** — отправляет событие `message` с заполненным `forward_origin`. Удобно для тестирования логики определения пересланных сообщений:

```ts
const msg = await user.sendMessage("Оригинальное сообщение");
await user.forwardMessage(msg, group); // переслано в группу
```

**`user.sendMediaGroup(chat, payloads[])`** — отправляет несколько событий `message` с одним `media_group_id`. Для тестирования обработки альбомов:

```ts
await user.sendMediaGroup(group, [
    { photo: {} },
    { video: {} },
]);
```

**`user.pinMessage(msg, inChat?)`** — отправляет служебное сообщение с `pinned_message`. GramIO направляет такие сообщения в событие `"pinned_message"`:

```ts
const msg = await user.sendMessage("Важное объявление");
await user.pinMessage(msg);
```

**`user.on(msg).clickByText(buttonText)`** — ищет в `inline_keyboard` кнопку с нужным текстом и кликает на её `callback_data`. Выбрасывает исключение, если кнопка не найдена:

```ts
// (бот ответил сообщением с кнопками "Да" и "Нет")
await user.on(botReply).clickByText("Да");
```

**Три новых медиа-метода**: `sendAudio()`, `sendAnimation()`, `sendVideoNote()` — с автогенерацией `file_id` и тем же API, что и у остальных медиа-методов:

```ts
await user.sendAudio({ caption: "Отличный трек" });
await user.sendAnimation(group, { caption: "Смешная гифка" });
await user.sendVideoNote(); // кружочек
```

**`ChatObject.post(text)`** — отправляет событие `channel_post` (без поля `from`) для тестирования ботов в каналах:

```ts
const channel = env.createChat({ type: "channel", title: "Мой канал" });
await channel.post("Новый пост из канала");
```

### [env.clearApiCalls() и env.lastApiCall()](https://github.com/gramiojs/test/commit/236e7a3651b1e34552a7a2a0eb8d0e9f163cc1a1)

Два новых хелпера для чистых проверок:

```ts
// Сбросить лог вызовов между фазами теста
env.clearApiCalls();

// Получить последний вызов для конкретного метода
const lastSend = env.lastApiCall("sendMessage");
expect(lastSend?.params.text).toBe("Добро пожаловать!");
```

---

## [@gramio/callback-data v0.1.0 — safeUnpack() и обратно-совместимые схемы](https://github.com/gramiojs/callback-data/compare/v0.0.11...v0.1.0)

### [safeUnpack() — больше не падаем на устаревших кнопках](https://github.com/gramiojs/callback-data/commit/758952458e1793709abc8cfa16f1d1d377cc6a98)

Кнопки инлайн-клавиатуры живут в истории чата днями и неделями. Если схема изменилась, `unpack()` падает на старых данных. Новый `safeUnpack()` никогда не бросает исключение — вместо этого возвращает дискриминированный union:

```ts
const data = new CallbackData("action").number("id").string("type");

bot.callbackQuery(data, (ctx) => {
    const result = data.safeUnpack(ctx.data!);
    if (!result.success) {
        // кнопка из старой версии схемы
        return ctx.answerCallbackQuery({ text: "Эта кнопка устарела!" });
    }

    console.log(result.data.id, result.data.type); // типизировано
});
```

Тип `SafeUnpackResult<T>` экспортируется для использования в собственных type guard-ах.

### [Добавление optional-полей теперь обратно совместимо](https://github.com/gramiojs/callback-data/commit/758952458e1793709abc8cfa16f1d1d377cc6a98)

Раньше любое добавление поля в схему — даже optional — ломало уже упакованные строки. Теперь, если данные упакованы без битмаски, все optional-поля считаются отсутствующими (значение `undefined` или дефолтное). **Добавление optional-полей в конец схемы стало безопасной операцией:**

```ts
// v1 схема (строки уже есть в истории чата)
const v1 = new CallbackData("page").number("id");

// v2 схема — добавление optional-поля безопасно!
const v2 = new CallbackData("page")
    .number("id")
    .string("tab", { optional: true }); // новое поле

// Старые v1-строки нормально распаковываются в v2
const result = v2.safeUnpack(v1PackedString);
// result.success === true, result.data.tab === undefined
```

Опасные операции (добавление required-поля, смена порядка, переименование `nameId`) по-прежнему остаются breaking change-ами.

---

## [@gramio/schema-parser v1.0.1 — новый движок схем](https://github.com/gramiojs/schema-parser)

Новый TypeScript-пакет для парсинга HTML-документации Telegram Bot API в структурированную типизированную схему. Питает `@gramio/types` — заменяя прежнюю зависимость от Rust-крейта `tg-bot-api`.

Схема поддерживает:
- **Семантические маркеры** — `semanticType: "formattable"` для текстовых полей, `"markup"` для объектов клавиатур, `"updateType"` для типов контекста
- **Определение загрузки файлов** — string-поля, принимающие файлы, становятся `InputFile | string`-юнионами
- **Enum валют** — синтезируется из `currencies.json` Telegram с `XTR` (Telegram Stars)
- **Правильные const-значения** — булевые литералы `true`/`false` вместо строк
- **Поддержка oneOf** — union-типы с ссылками и описаниями

---

## [@gramio/types v9.4.2 — нативная схема, улучшенная семантика](https://github.com/gramiojs/types/compare/v9.4.1...v9.4.2)

Пакет переехал с `tg-bot-api` (Rust-крейт) на `@gramio/schema-parser` (TypeScript). Генерируемый вывод теперь содержит:

- Более точные `InputFile | string`-юнионы для параметров загрузки файлов
- Formattable-поля правильно типизированы через семантические маркеры
- Enum `Currencies` со всеми поддерживаемыми валютами, включая `XTR` для Stars
- Типы `APIResponse`, `APIResponseOk`, `APIResponseError` (раньше отсутствовали)

---

## [gramio — новая система фильтров (в разработке)](https://github.com/gramiojs/gramio/compare/v0.5.0...main)

В релиз ещё не попало, но на `main` уже приземлилось:

### [Перегрузки filter-only .on()](https://github.com/gramiojs/gramio/commit/17b4f67b0e4e96ee6cec7e5e87cba7c4aa7e39fd)

`.on()` теперь принимает просто предикат — без указания имени события. GramIO сам определяет совместимые события из type-narrowing предиката:

```ts
// Type-narrowing предикат — сужает тип контекста в обработчике
bot.on((ctx): ctx is { text: string } => typeof ctx.text === "string", (ctx) => {
    ctx.text; // string (не string | undefined)
});
```

### [Новые фильтры по свойствам сообщения](https://github.com/gramiojs/gramio/commit/5ac7cf31bc94a4a56a15e3e5f98a2b2e56b6c0ae)

Standalone-предикаты для сужения типов в обработчиках:

```ts
import { filters } from "gramio";

bot.on("message", filters.reply, (ctx) => {
    ctx.replyToMessage; // гарантированно присутствует
});

bot.on("message", filters.entities, handler);  // есть entities
bot.on("message", filters.quote, handler);      // цитата
bot.on("message", filters.isBot, handler);      // отправитель — бот
bot.on("message", filters.isPremium, handler);  // есть Premium
```

### [forwardOrigin() и senderChat() как callable-перегрузки](https://github.com/gramiojs/gramio/commit/affb6cf6bc8f5dc8f6ee6b1d39b02deeffd3f1d6)

Раньше были отдельными фильтрами, теперь — единая callable-перегрузка с опциональным сужением типа:

```ts
// Сужает до сообщений, пересланных от пользователя
bot.on("message", filters.forwardOrigin("user"), (ctx) => {
    ctx.forwardOrigin; // MessageOriginUser — полностью типизировано
});

// Без аргумента — матчит любое пересланное сообщение
bot.on("message", filters.forwardOrigin(), handler);
```

---

## Документация

### [Запущен TypeScript API Reference по адресу /api/](https://github.com/gramiojs/documentation/commit/1727817b6b3f3ac82bcb1e8f9f048cae01dc6c1)

Полный TypeDoc-справочник доступен по адресу [`/api/`](/api/). Охватывает все основные и плагиновые пакеты — `gramio`, `@gramio/contexts`, `@gramio/types`, `@gramio/keyboards`, `@gramio/callback-data`, `@gramio/composer` и дюжину плагинов. Сайдбар генерируется автоматически и выпрямляет пути внутренних модулей.

### [Запущен справочник Telegram Bot API по адресу /telegram/](https://github.com/gramiojs/documentation/commit/16c41693ff3b01b54ded1c56e2da1ccf0e95a4a2)

Более 200 методов и типов Telegram Bot API теперь имеют отдельные страницы с примерами GramIO, таблицами параметров (с ограничениями, типами и пометками required/optional), таблицами ошибок, советами и перекрёстными ссылками на связанные методы.

### [Антипаттерны форматирования](https://github.com/gramiojs/documentation/commit/3dad7f8)

В руководство по форматированию добавлены критические правила:

```ts
// ❌ НЕПРАВИЛЬНО — никогда не используйте parse_mode вместе с @gramio/format
ctx.send({ text: format`${bold("привет")}`, parse_mode: "HTML" });

// ❌ НЕПРАВИЛЬНО — никогда не делайте .join() из массива Formattable (теряются offset)
[bold("а"), italic("б")].join(", ");

// ✅ ПРАВИЛЬНО — используйте хелпер join() из @gramio/format
import { join } from "gramio";
join([bold("а"), italic("б")], ", ");
```

### [Расширена документация плагина Session](https://github.com/gramiojs/documentation/commit/561c7bd)

Документация сессий теперь включает ленивую загрузку, `$clear()` для удаления сессии, функции кастомных ключей для разграничения по чату/пользователю и явную типизацию для обоих режимов — eager и lazy.
